<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zutaten-Analysator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #dbcbff 0%, #bbc5fc 100%);
            min-height: 100vh;
            padding: 20px;
            color: #334155;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .header {
            background: #2d3748;
            color: white;
            padding: 32px 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
            color: #cbd5e0;
        }

        .footer {
            background: #2d3748;
            color: white;
            padding: 24px;
            text-align: center;
            font-size: 0.9rem;
            margin-top: auto;
        }

        /* Icon spacing */
        .button i,
        h1 i,
        h3 i {
            margin-right: 8px;
        }

        .content {
            padding: 32px 24px;
        }

        .api-key-section {
            margin-bottom: 24px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background-color: #f8fafc;
            display: none;
        }

        .api-key-section.show {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e293b;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            font-family: inherit;
            color: #334155;
        }

        .input-group input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .input-group input::placeholder {
            color: #94a3b8;
        }

        .camera-section {
            text-align: center;
            margin-bottom: 24px;
        }

        .camera-container {
            position: relative;
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            display: none;
        }

        .captured-image {
            width: 100%;
            max-width: 100%;
            border-radius: 12px;
            display: none;
        }

        .button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 8px;
            min-width: 120px;
            font-family: inherit;
        }

        .button:hover {
            background: #0284c7;
            transform: translateY(-1px);
        }

        .button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: #ef4444;
            color: white;
        }

        .button.secondary:hover {
            background: #dc2626;
        }

        .results {
            margin-top: 24px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            border: 1px solid #e2e8f0;
        }

        .results.success {
            background: #dcfce7;
            border-color: #bbf7d0;
            color: #14532d;
        }

        .results.warning {
            background: #fef3c7;
            border-color: #fde68a;
            color: #92400e;
        }

        .results.error {
            background: #fecaca;
            border-color: #fca5a5;
            color: #991b1b;
        }

        .results h3 {
            margin-bottom: 16px;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .ingredient-list {
            list-style: none;
            padding: 0;
        }

        .ingredient-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .ingredient-list li:last-child {
            border-bottom: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 24px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #f1f5f9;
            border-top: 3px solid #0ea5e9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .setup-button {
            background: #0ea5e9;
            margin-bottom: 12px;
        }

        .setup-button:hover {
            background: #0284c7;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            .header {
                padding: 24px 20px;
            }

            .header h1 {
                font-size: 1.75rem;
            }

            .content {
                padding: 24px 20px;
            }

            .button {
                width: 100%;
                margin: 6px 0;
            }
        }

        .settings-section,
        .api-key-section {
            margin-bottom: 24px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background-color: #f8fafc;
            display: none;
        }

        .settings-section.show,
        .api-key-section.show {
            display: block;
        }

        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.125rem;
            color: #1e293b;
            font-weight: 600;
        }

        .settings-section h4 {
            margin-bottom: 12px;
            font-size: 1rem;
            color: #1e293b;
            font-weight: 600;
        }

        .current-ingredients-list {
            list-style: none;
            padding: 0;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            background: #ffffff;
        }

        .current-ingredients-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #f1f5f9;
        }

        .current-ingredients-list li:last-child {
            border-bottom: none;
        }

        .current-ingredients-list .ingredient-text {
            flex-grow: 1;
            margin-right: 12px;
            font-size: 0.95rem;
        }

        .current-ingredients-list .ingredient-text strong {
            color: #1e293b;
            font-weight: 600;
        }

        .current-ingredients-list .ingredient-details {
            font-size: 0.85rem;
            color: #64748b;
            display: block;
            margin-top: 4px;
        }

        .current-ingredients-list .remove-ingredient-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            flex-shrink: 0;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .current-ingredients-list .remove-ingredient-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-search"></i> Zutaten-Analyse</h1>
            <p>Prüfe Lebensmittel auf unverträgliche Zutaten</p>
        </div>

        <div class="content">
            <button id="setupBtn" class="button setup-button"><i class="fas fa-cog"></i> API-Keys einrichten</button>
            <button id="customizeIngredientsBtn" class="button setup-button"><i class="fas fa-wrench"></i> Zutaten anpassen</button>

            <div id="apiKeySection" class="api-key-section">
                <div class="input-group">
                    <label for="apiKey">OpenAI API-Key:</label>
                    <input type="password" id="apiKey" placeholder="sk-..." />
                </div>
                <div class="input-group">
                    <label for="livingAppsApiKey">LivingApps API-Key:</label>
                    <input type="password" id="livingAppsApiKey" placeholder="6877a8cfn..." />
                </div>
                <button id="saveApiKey" class="button"><i class="fas fa-save"></i> Speichern & Fortfahren</button>
            </div>

            <div id="ingredientSettingsSection" class="settings-section">
                <h3>Problematische Zutaten anpassen</h3>
                <div class="input-group">
                    <label for="newIngredientName">Zutat (z.B. Aspartam):</label>
                    <input type="text" id="newIngredientName" placeholder="Zutat eingeben" />
                </div>
                <div class="input-group">
                    <label for="newIngredientDetails">Details/Beispiele (z.B. künstlicher Süßstoff E951):</label>
                    <input type="text" id="newIngredientDetails" placeholder="Optional: Beispiele, E-Nummern" />
                </div>
                <button id="addIngredientBtn" class="button" style="margin-bottom: 20px;"><i class="fas fa-plus"></i> Zutat hinzufügen</button>

                <h4>Aktuelle Liste: <span id="ingredientsLoadingIndicator" style="display: none; color: #64748b; font-size: 0.8rem; font-weight: normal;"><i class="fas fa-sync-alt fa-spin"></i> Lade...</span></h4>
                <ul id="currentIngredientsList" class="current-ingredients-list">
                    <!-- Zutaten werden hier von JavaScript eingefügt -->
                </ul>
                <button id="saveIngredientSettingsBtn" class="button"><i class="fas fa-save"></i> Speichern & Schließen</button>
            </div>

            <div id="mainApp" style="display: none;">
                <div class="camera-section">
                    <div class="camera-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas"></canvas>
                        <img id="capturedImage" class="captured-image" alt="Aufgenommene Zutatenliste" />
                    </div>

                    <button id="startCamera" class="button"><i class="fas fa-camera"></i> Kamera starten</button>
                    <button id="captureBtn" class="button" style="display: none;"><i class="fas fa-camera"></i> Foto aufnehmen</button>
                    <button id="retakeBtn" class="button secondary" style="display: none;"><i class="fas fa-redo"></i> Wiederholen</button>
                    <button id="analyzeBtn" class="button" style="display: none;"><i class="fas fa-search"></i> Zutaten analysieren</button>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Analysiere Zutaten...</p>
                </div>

                <div id="results" class="results">
                    <h3 id="resultsTitle"></h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            Made with <i class="fas fa-heart" style="color: #f87171;"></i> by Lilo and LivingApps.
        </div>
    </div>

    <script>
        class IngredientAnalyzer {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.capturedImage = document.getElementById('capturedImage');
                this.apiKey = localStorage.getItem('openai_api_key') || '';
                this.livingAppsApiKey = localStorage.getItem('livingapps_api_key') || '';
                this.livingAppsBaseUrl = 'https://my.living-apps.de/rest';
                this.ingredientsAppId = '6877b14318925c43e8886097';
                this.stream = null;

                // Initialize custom ingredients from LivingApp
                this.customIngredients = [];

                this.initializeEventListeners();
                this.checkApiKey();
                this.loadCustomIngredients();
            }

            initializeEventListeners() {
                document.getElementById('setupBtn').addEventListener('click', () => this.showApiKeySetup());
                document.getElementById('saveApiKey').addEventListener('click', () => this.saveApiKey());
                document.getElementById('startCamera').addEventListener('click', () => this.startCamera());
                document.getElementById('captureBtn').addEventListener('click', () => this.capturePhoto());
                document.getElementById('retakeBtn').addEventListener('click', () => this.retakePhoto());
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeIngredients());

                // Add ingredient customization event listeners
                document.getElementById('customizeIngredientsBtn').addEventListener('click', () => this.showIngredientSettings());
                document.getElementById('addIngredientBtn').addEventListener('click', () => this.addCustomIngredient());
                document.getElementById('saveIngredientSettingsBtn').addEventListener('click', () => this.saveIngredientSettings());

                // Add Enter key support for adding ingredients
                document.getElementById('newIngredientName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomIngredient();
                });
                document.getElementById('newIngredientDetails').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.addCustomIngredient();
                });
            }

            checkApiKey() {
                if (this.apiKey && this.livingAppsApiKey) {
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('setupBtn').innerHTML = '<i class="fas fa-cog"></i> API-Keys ändern';
                }
            }

            showApiKeySetup() {
                const section = document.getElementById('apiKeySection');
                section.classList.toggle('show');
                if (this.apiKey) {
                    document.getElementById('apiKey').value = this.apiKey;
                }
                if (this.livingAppsApiKey) {
                    document.getElementById('livingAppsApiKey').value = this.livingAppsApiKey;
                }
            }

            saveApiKey() {
                const apiKeyInput = document.getElementById('apiKey');
                const livingAppsApiKeyInput = document.getElementById('livingAppsApiKey');
                const apiKey = apiKeyInput.value.trim();
                const livingAppsApiKey = livingAppsApiKeyInput.value.trim();

                if (!apiKey.startsWith('sk-')) {
                    alert('Bitte geben Sie einen gültigen OpenAI API-Key ein (beginnt mit sk-)');
                    return;
                }

                if (!livingAppsApiKey) {
                    alert('Bitte geben Sie einen gültigen LivingApps API-Key ein');
                    return;
                }

                this.apiKey = apiKey;
                this.livingAppsApiKey = livingAppsApiKey;
                localStorage.setItem('openai_api_key', apiKey);
                localStorage.setItem('livingapps_api_key', livingAppsApiKey);

                document.getElementById('apiKeySection').classList.remove('show');
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('setupBtn').innerHTML = '<i class="fas fa-cog"></i> API-Key ändern';

                // Load ingredients after API keys are set
                this.loadCustomIngredients();
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment', // Use back camera on mobile
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });

                    this.video.srcObject = this.stream;
                    this.video.style.display = 'block';
                    this.capturedImage.style.display = 'none';

                    document.getElementById('startCamera').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'inline-block';
                    document.getElementById('retakeBtn').style.display = 'none';
                    document.getElementById('analyzeBtn').style.display = 'none';

                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Kamera konnte nicht geöffnet werden. Bitte stellen Sie sicher, dass Sie Kamera-Berechtigungen erteilt haben.');
                }
            }

            capturePhoto() {
                const context = this.canvas.getContext('2d');
                this.canvas.width = this.video.videoWidth;
                this.canvas.height = this.video.videoHeight;

                context.drawImage(this.video, 0, 0);

                const imageDataUrl = this.canvas.toDataURL('image/jpeg', 0.8);
                this.capturedImage.src = imageDataUrl;
                this.capturedImage.style.display = 'block';
                this.video.style.display = 'none';

                // Stop camera stream
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }

                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('retakeBtn').style.display = 'inline-block';
                document.getElementById('analyzeBtn').style.display = 'inline-block';
            }

            retakePhoto() {
                this.capturedImage.style.display = 'none';
                document.getElementById('retakeBtn').style.display = 'none';
                document.getElementById('analyzeBtn').style.display = 'none';
                document.getElementById('startCamera').style.display = 'inline-block';
                document.getElementById('results').style.display = 'none';
            }

            async analyzeIngredients() {
                if (!this.apiKey || !this.livingAppsApiKey) {
                    alert('Bitte richten Sie zuerst Ihre API-Keys ein.');
                    return;
                }

                const loading = document.getElementById('loading');
                const results = document.getElementById('results');

                loading.classList.add('show');
                results.style.display = 'none';

                try {
                    const imageDataUrl = this.capturedImage.src;
                    const base64Image = imageDataUrl.split(',')[1];

                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify({
                            model: "gpt-4o",
                            messages: [
                                {
                                    role: "user",
                                    content: [
                                                                                {
                                            type: "text",
                                            text: this.generateIngredientPrompt()
                                        },
                                        {
                                            type: "image_url",
                                            image_url: {
                                                url: imageDataUrl
                                            }
                                        }
                                    ]
                                }
                            ],
                            max_tokens: 500
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                                        const data = await response.json();
                    const analysisText = data.choices[0].message.content;

                    // Try to parse JSON response, handling markdown code blocks
                    let analysis;
                    try {
                        // Remove markdown code blocks if present
                        let jsonText = analysisText;
                        const jsonMatch = analysisText.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                        if (jsonMatch) {
                            jsonText = jsonMatch[1];
                        }

                        analysis = JSON.parse(jsonText);
                    } catch (e) {
                        // Fallback if JSON parsing fails
                        analysis = {
                            status: "warning",
                            message: "Analysis completed",
                            problematic_ingredients: [],
                            details: analysisText
                        };
                    }

                    this.displayResults(analysis);

                } catch (error) {
                    console.error('Analysis error:', error);
                    this.displayError(error.message);
                } finally {
                    loading.classList.remove('show');
                }
            }

            displayResults(analysis) {
                const results = document.getElementById('results');
                const title = document.getElementById('resultsTitle');
                const content = document.getElementById('resultsContent');

                results.className = 'results';

                if (analysis.status === 'ok') {
                    results.classList.add('success');
                    title.innerHTML = '<i class="fas fa-check-circle"></i> Alles in Ordnung!';
                    content.innerHTML = `<p><strong>${analysis.message}</strong></p><p>${analysis.details}</p>`;
                } else {
                    results.classList.add('warning');
                    title.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Problematische Zutaten gefunden';

                    let html = `<p><strong>${analysis.message}</strong></p>`;

                    if (analysis.problematic_ingredients && analysis.problematic_ingredients.length > 0) {
                        html += '<p><strong>Problematische Zutaten:</strong></p>';
                        html += '<ul class="ingredient-list">';
                        analysis.problematic_ingredients.forEach(ingredient => {
                            html += `<li>• ${ingredient}</li>`;
                        });
                        html += '</ul>';
                    }

                    html += `<p><strong>Details:</strong><br>${analysis.details}</p>`;
                    content.innerHTML = html;
                }

                results.style.display = 'block';
            }

            displayError(errorMessage) {
                const results = document.getElementById('results');
                const title = document.getElementById('resultsTitle');
                const content = document.getElementById('resultsContent');

                results.className = 'results error';
                title.innerHTML = '<i class="fas fa-times-circle"></i> Analyse-Fehler';
                content.innerHTML = `<p>Entschuldigung, es gab einen Fehler bei der Bildanalyse:</p><p><strong>${errorMessage}</strong></p><p>Bitte versuchen Sie es erneut oder überprüfen Sie Ihren API-Key.</p>`;
                results.style.display = 'block';
            }

            // Ingredient customization methods
            async loadCustomIngredients() {
                const loadingIndicator = document.getElementById('ingredientsLoadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'inline';
                }

                if (!this.livingAppsApiKey) {
                    console.warn('LivingApps API key not set, using default ingredients');
                    this.customIngredients = [
                        { name: "Farbstoffe", details: "künstliche Farben wie E102, E110, E124, E129, usw." },
                        { name: "Konservierungsstoffe", details: "wie E200-E299, BHA, BHT, usw." },
                        { name: "Rauch oder Raucharoma", details: "Rauch, Raucharoma, Rauchgeschmack, usw." },
                        { name: "Karamell oder ähnliches", details: "Karamell, Karamellfarbe, Karamellgeschmack, usw." }
                    ];
                    this.loadIngredientsList();
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    return;
                }

                try {
                    const response = await fetch(`${this.livingAppsBaseUrl}/apps/${this.ingredientsAppId}/records?filter=r.v_is_active == True&orderby=r.v_name`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `LA-Login-Token ${this.livingAppsApiKey}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    this.customIngredients = [];

                    // Convert LivingApp records to local format
                    Object.values(data).forEach(record => {
                        if (record.fields) {
                            this.customIngredients.push({
                                id: record.id,
                                name: record.fields.name || '',
                                details: record.fields.details || '',
                                category: record.fields.category || '',
                                severity: record.fields.severity || ''
                            });
                        }
                    });

                                        console.log(`Loaded ${this.customIngredients.length} ingredients from LivingApp`);
                    this.loadIngredientsList();

                } catch (error) {
                    console.error('Error loading ingredients from LivingApp:', error);
                    alert('Fehler beim Laden der Zutaten. Bitte überprüfen Sie Ihren LivingApps API-Key.');

                    // Fall back to default ingredients
                    this.customIngredients = [
                        { name: "Farbstoffe", details: "künstliche Farben wie E102, E110, E124, E129, usw." },
                        { name: "Konservierungsstoffe", details: "wie E200-E299, BHA, BHT, usw." },
                        { name: "Rauch oder Raucharoma", details: "Rauch, Raucharoma, Rauchgeschmack, usw." },
                        { name: "Karamell oder ähnliches", details: "Karamell, Karamellfarbe, Karamellgeschmack, usw." }
                    ];
                    this.loadIngredientsList();
                } finally {
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                }
            }

            showIngredientSettings() {
                const section = document.getElementById('ingredientSettingsSection');
                section.classList.toggle('show');
                // Refresh the list from the API
                this.loadCustomIngredients();
            }

            loadIngredientsList() {
                const list = document.getElementById('currentIngredientsList');
                list.innerHTML = '';

                this.customIngredients.forEach((ingredient, index) => {
                    const li = document.createElement('li');
                    const categoryBadge = ingredient.category ? `<span style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px;">${ingredient.category}</span>` : '';
                    const severityBadge = ingredient.severity ? `<span style="background: ${ingredient.severity === 'hoch' ? '#fecaca' : ingredient.severity === 'mittel' ? '#fed7aa' : '#dcfce7'}; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 4px;">${ingredient.severity}</span>` : '';

                    li.innerHTML = `
                        <div class="ingredient-text">
                            <strong>${ingredient.name}</strong>${categoryBadge}${severityBadge}
                            ${ingredient.details ? `<div class="ingredient-details">${ingredient.details}</div>` : ''}
                        </div>
                        <button class="remove-ingredient-btn" onclick="ingredientAnalyzer.removeCustomIngredient(${index})"><i class="fas fa-trash-alt"></i> Entfernen</button>
                    `;
                    list.appendChild(li);
                });

                if (this.customIngredients.length === 0) {
                    const li = document.createElement('li');
                    li.innerHTML = '<div style="text-align: center; color: #64748b; font-style: italic;">Keine Zutaten gefunden. Fügen Sie neue Zutaten hinzu oder überprüfen Sie Ihren API-Key.</div>';
                    list.appendChild(li);
                }
            }

            async addCustomIngredient() {
                const nameInput = document.getElementById('newIngredientName');
                const detailsInput = document.getElementById('newIngredientDetails');

                const name = nameInput.value.trim();
                const details = detailsInput.value.trim();

                if (!name) {
                    alert('Bitte geben Sie einen Zutatennamen ein.');
                    return;
                }

                if (!this.livingAppsApiKey) {
                    alert('LivingApps API-Key ist nicht konfiguriert.');
                    return;
                }

                // Check if ingredient already exists
                const exists = this.customIngredients.some(ingredient =>
                    ingredient.name.toLowerCase() === name.toLowerCase()
                );

                if (exists) {
                    alert('Diese Zutat ist bereits in Ihrer Liste.');
                    return;
                }

                try {
                    // Create new record in LivingApp
                    const recordData = {
                        fields: {
                            name: name,
                            details: details || '',
                            category: 'sonstige',
                            severity: 'mittel',
                            is_active: true,
                            date_added: new Date().toISOString().split('T')[0],
                            notes: 'Benutzer-definierte Zutat'
                        }
                    };

                    const response = await fetch(`${this.livingAppsBaseUrl}/apps/${this.ingredientsAppId}/records`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `LA-Login-Token ${this.livingAppsApiKey}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(recordData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('Created ingredient:', result);

                    // Clear inputs
                    nameInput.value = '';
                    detailsInput.value = '';
                    nameInput.focus();

                    // Reload ingredients list
                    await this.loadCustomIngredients();

                } catch (error) {
                    console.error('Error creating ingredient:', error);
                    alert('Fehler beim Hinzufügen der Zutat. Bitte versuchen Sie es erneut.');
                }
            }

            async removeCustomIngredient(index) {
                const ingredient = this.customIngredients[index];
                if (!confirm(`"${ingredient.name}" aus Ihrer Liste entfernen?`)) {
                    return;
                }

                if (!this.livingAppsApiKey) {
                    alert('LivingApps API-Key ist nicht konfiguriert.');
                    return;
                }

                if (!ingredient.id) {
                    alert('Ingredient ID nicht gefunden. Kann nicht gelöscht werden.');
                    return;
                }

                try {
                    const response = await fetch(`${this.livingAppsBaseUrl}/apps/${this.ingredientsAppId}/records/${ingredient.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `LA-Login-Token ${this.livingAppsApiKey}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    console.log('Deleted ingredient:', ingredient.name);

                    // Reload ingredients list
                    await this.loadCustomIngredients();

                } catch (error) {
                    console.error('Error deleting ingredient:', error);
                    alert('Fehler beim Löschen der Zutat. Bitte versuchen Sie es erneut.');
                }
            }

            async saveIngredientSettings() {
                document.getElementById('ingredientSettingsSection').classList.remove('show');
                // Refresh ingredients to ensure we have the latest data
                await this.loadCustomIngredients();
            }

            generateIngredientPrompt() {
                const ingredientList = this.customIngredients.map((ingredient, index) =>
                    `${index + 1}. ${ingredient.name} (${ingredient.details})`
                ).join('\n');

                return `Analysiere diese Zutatenliste für die folgenden problematischen Zutaten:

${ingredientList}

Bitte antworte in diesem exakten JSON-Format:
{
  "status": "ok" oder "warning",
  "message": "kurze Zusammenfassung",
  "problematic_ingredients": ["Liste der gefundenen problematischen Zutaten, leeres Array falls keine"],
  "details": "detaillierte Erklärung der Befunde"
}

Falls keine dieser problematischen Zutaten gefunden werden, setze status auf "ok". Falls welche gefunden werden, setze status auf "warning" und liste sie auf.`;
            }
        }

        // Initialize the app when the page loads
        let ingredientAnalyzer;
        document.addEventListener('DOMContentLoaded', () => {
            ingredientAnalyzer = new IngredientAnalyzer();
        });

        // Register service worker for PWA functionality (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/checkmyfood/sw.js').catch(() => {
                    // Service worker registration failed, but that's okay
                });
            });
        }
    </script>
</body>
</html>
